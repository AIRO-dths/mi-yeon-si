<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIRO - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "M PLUS Rounded 1c", sans-serif;
      }
      /* 스크롤바를 각 섹션 내부에만 적용하기 위한 스타일 */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body class="bg-gray-100 h-screen overflow-hidden">
    <header class="bg-white shadow z-10">
      <div class="max-w-full mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold text-gray-900 text-center">AIRO</h1>
      </div>
    </header>
    <main class="flex h-[calc(100vh-88px)]">
      <!-- 남자 리스트 섹션 -->
      <section class="w-1/2 p-4 overflow-y-auto custom-scrollbar">
        <h2
          class="text-2xl font-bold text-gray-700 mb-4 sticky top-0 bg-gray-100 py-2"
        >
          남자
        </h2>
        <div id="men-list" class="space-y-4">
          <!-- 남자 사용자 카드가 여기에 동적으로 추가됩니다 -->
        </div>
      </section>

      <!-- 여자 리스트 섹션 -->
      <section
        class="w-1/2 p-4 overflow-y-auto custom-scrollbar border-l border-gray-300"
      >
        <h2
          class="text-2xl font-bold text-gray-700 mb-4 sticky top-0 bg-gray-100 py-2"
        >
          여자
        </h2>
        <div id="women-list" class="space-y-4">
          <!-- 여자 사용자 카드가 여기에 동적으로 추가됩니다 -->
        </div>
      </section>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const menListContainer = document.getElementById("men-list");
        const womenListContainer = document.getElementById("women-list");

        // 로딩 메시지 표시
        menListContainer.innerHTML =
          '<p class="text-center text-gray-500">데이터를 불러오는 중...</p>';
        womenListContainer.innerHTML = "";

        fetch("/api/dashboard")
          .then((response) => response.json())
          .then((users) => {
            // 데이터 로딩 메시지 제거
            menListContainer.innerHTML = "";

            // 사용자를 성별에 따라 분류
            const men = users.filter((user) => user.gender === "남자");
            const women = users.filter((user) => user.gender === "여자");

            // 남자 리스트 렌더링
            if (men.length === 0) {
              menListContainer.innerHTML =
                '<p class="text-center text-gray-500">등록된 남자 사용자가 없습니다.</p>';
            } else {
              men.forEach((user) => {
                menListContainer.appendChild(createUserCard(user));
                console.log(user);
              });
            }

            // 여자 리스트 렌더링
            if (women.length === 0) {
              womenListContainer.innerHTML =
                '<p class="text-center text-gray-500">등록된 여자 사용자가 없습니다.</p>';
            } else {
              women.forEach((user) => {
                womenListContainer.appendChild(createUserCard(user));
              });
            }
          })
          .catch((error) => {
            console.error("Error fetching dashboard data:", error);
            menListContainer.innerHTML =
              '<p class="text-center text-red-500">데이터를 불러오는 데 실패했습니다.</p>';
            womenListContainer.innerHTML = "";
          });
      });

      // 사용자 카드를 생성하는 함수 (재사용 가능하도록 분리)
      function createUserCard(user) {
        const userCard = document.createElement("div");
        userCard.className =
          "bg-white p-4 rounded-lg shadow-md flex items-start space-x-4";

        let chatHistoryHtml = "";
        if (user.chats && user.chats.length > 0) {
          chatHistoryHtml =
            '<div id="chat-history-' +
            user.id +
            '" class="mt-4 space-y-2 hidden">';
          user.chats.forEach((chat) => {
            chatHistoryHtml += `
                        <div class="border-l-4 border-blue-500 pl-4 text-sm">
                            <p class="font-semibold text-gray-700">나:</p>
                            <p class="text-gray-600">${chat.user_message}</p>
                            <p class="font-semibold text-gray-700 mt-2">AIRO:</p>
                            <p class="text-gray-600">${chat.bot_response}</p>
                        </div>
                    `;
          });
          chatHistoryHtml += "</div>";
        } else {
          chatHistoryHtml =
            '<div id="chat-history-' +
            user.id +
            '" class="mt-4 text-gray-500 text-sm hidden">대화 기록이 없습니다.</div>';
        }

        userCard.innerHTML = `
                <img src="" class="w-24 h-24 rounded-xl object-cover border-2 border-gray-200 cursor-pointer hover:opacity-80 transition flex-shrink-0">
                <div class="flex-grow">
                    <h2 class="text-lg font-bold text-gray-800">${
                      user.name
                    }</h2>
                    <p class="text-gray-700 font-bold text-base">${
                      user.face_type
                    }상</p>
                    <p class="text-gray-500 text-sm">${user.gender}</p>
                    <div id="score-${
                      user.id
                    }" class="mt-3 text-sm text-gray-700">
                    <p class="text-gray-400">AI 점수 불러오는 중...</p>
                    </div>
                    <button onclick="toggleChatHistory(${
                      user.id
                    })" class="mt-2 w-full text-left font-semibold text-gray-700 bg-gray-100 p-2 rounded hover:bg-gray-200 transition flex justify-between items-center">
                        <span>대화 기록 (${
                          user.chats ? user.chats.length : 0
                        }건)</span>
                        <svg id="chevron-${
                          user.id
                        }" class="w-5 h-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    ${chatHistoryHtml}
                </div>
            `;
        fetchUserScore(user.id);

        return userCard;
      }

      // 대화 기록 토글 함수
      function toggleChatHistory(userId) {
        const history = document.getElementById(`chat-history-${userId}`);
        const chevron = document.getElementById(`chevron-${userId}`);

        if (history.classList.contains("hidden")) {
          history.classList.remove("hidden");
          chevron.classList.add("rotate-180");
        } else {
          history.classList.add("hidden");
          chevron.classList.remove("rotate-180");
        }
      }

      //   점수 추가
      function fetchUserScore(userId) {
        fetch(`/api/user/${userId}/score`)
          .then((res) => res.json())
          .then((score) => {
            const box = document.getElementById(`score-${userId}`);
            box.innerHTML = `
        <p>친근함 : <b>${score.friend_user}</b></p>
        <p>매력  : <b>${score.attract_user}</b></p>
        <p>재미  : <b>${score.fun_user}</b></p>
        <p>공감  : <b>${score.blri_user}</b></p>
      `;
          })
          .catch(() => {
            const box = document.getElementById(`score-${userId}`);
            box.innerHTML = `<p class="text-red-400">점수 없음</p>`;
          });
      }

      function reload_page() {
        setTimeout("location.reload()", 300000);
      }
      reload_page();
    </script>
  </body>
</html>
